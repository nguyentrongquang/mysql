----TẠO DATABASE QLSACH
CREATE DATABASE DUAN12

-----BẢNG THỂ LOẠI

IF OBJECT_ID('THELOAI') IS NOT NULL
  DROP TABLE THELOAI
GO
CREATE TABLE THELOAI
(
MTL   NVARCHAR(10) NOT NULL,
TENTL NVARCHAR(50) NULL,
hinh  NVARCHAR(50) NULL, 
MOTA  NVARCHAR(50) NULL, 
CONSTRAINT PK_THELOAI PRIMARY KEY(MTL)
)


------TAO BANG SACH
IF OBJECT_ID('SACH') IS NOT NULL
  DROP TABLE SACH
GO 
CREATE TABLE SACH
(
MASACH NVARCHAR(10) NOT NULL,
MTL    NVARCHAR(10) NOT NULL,
TENSACH NVARCHAR(50) NULL,
SOTRANG INT NULL,
SOBANSAO INT NULL,
GIABIA   int NULL,
NXB  DATETIME NULL,
VITRI NVARCHAR(50) NULL,
NHANXET NVARCHAR(100) NULL,
SLT INT NULL,
CONSTRAINT PK_SACH PRIMARY KEY(MASACH),
---CONSTRAINT FK_THELOAI_SACH FOREIGN KEY(MTL) REFERENCES THELOAI
)
----TAO BANG SACH_TACGIA

-----TAO BANG NGANH
IF OBJECT_ID('NGANH') IS NOT NULL
  DROP TABLE NGANH
GO
CREATE TABLE NGANH
(
MANGANH NVARCHAR(10) NOT NULL,
TENNGANH NVARCHAR(50) NULL,
GHICHU NVARCHAR(50) NULL,
CONSTRAINT PK_NGANH PRIMARY KEY(MANGANH)
)

------TAO BANG LOP
IF OBJECT_ID('LOP') IS NOT NULL
  DROP TABLE LOP
GO
CREATE TABLE LOP
(
MALOP NVARCHAR(10) NOT NULL,
TENLOP NVARCHAR(50) NULL,
MANGANH NVARCHAR(10) NOT NULL,
CONSTRAINT PK_LOP PRIMARY KEY(MALOP),
CONSTRAINT FK_LOP_NGANH FOREIGN KEY(MANGANH) REFERENCES NGANH
)
------TAO BANG SINH VIEN
IF OBJECT_ID('SINHVIEN') IS NOT NULL
  DROP TABLE SINHVIEN
GO
CREATE TABLE SINHVIEN
(
MSV NVARCHAR(10) NOT NULL,
TEN  NVARCHAR(20) NULL,
GIOITINH bit NULL,
DIACHI NVARCHAR(50) NULL,
EMAIL NVARCHAR(50) NULL,
SDT   NVARCHAR(13) NULL,
HINH NVARCHAR(100) null,
MALOP NVARCHAR(10) NULL,
CONSTRAINT PK_SINHVIEN PRIMARY KEY(MSV),
CONSTRAINT FK_LOP_SINHVIEN FOREIGN KEY(MALOP) REFERENCES LOP
)
------TAO BANG PHIEU MUON
IF OBJECT_ID('PHIEUMUON') IS NOT NULL
   DROP TABLE PHIEUMUON
GO
CREATE TABLE PHIEUMUON
(
MSP NVARCHAR(10) NOT NULL,
NGAYMUON DATETIME NULL,
MSV NVARCHAR(10) NOT NULL,

CONSTRAINT PK_PHIEUMUON PRIMARY KEY(MSP),
CONSTRAINT FK_SINHVIEN_PHIEUMUON FOREIGN KEY(MSV) REFERENCES SINHVIEN

)
------TAO BANG CT PHIEU MUON
IF OBJECT_ID('CTPHIEUUON') IS NOT NULL
  DROP TABLE CTPHIEUMUON
GO
CREATE TABLE CTPHIEUMUON
(
MANV NVARCHAR(10) NOT NULL,
MSV  NVARCHAR(10) NOT NULL,
MSP NVARCHAR(10) NOT NULL,
MASACH NVARCHAR(10) NOT NULL,
SOLUONG INT NULL,
CONSTRAINT FK_CTPHIEUMUON_NHANVIEN FOREIGN KEY(MANV)REFERENCES NHANVIEN,
CONSTRAINT FK_CTPHIEUMUON_SINHVIEN FOREIGN KEY(MSV)REFERENCES SINHVIEN,
CONSTRAINT FK_CTPHIEUMUON_PHIEUMUON FOREIGN KEY(MSP) REFERENCES PHIEUMUON,
CONSTRAINT FK_CTPHIEUMUON_SACH FOREIGN KEY(MASACH) REFERENCES SACH,
)
-------------- nhân viên
IF OBJECT_ID('NHANVIEN') IS NOT NULL
 DROP TABLE NHANVIEN
GO
CREATE TABLE NHANVIEN
(
MANV   NVARCHAR(10) NOT NULL,
MATKHAU NVARCHAR(50) NULL,
HOTEN  NVARCHAR(50) NULL, 
GIOITINH bit NULL,
SDT NVARCHAR(50) NULL,
DIACHI  NVARCHAR(50) NULL, 
VAITRO  bit NULL, 
CONSTRAINT PK_NHANVIEN PRIMARY KEY(MANV)
)

-------------TAO BANG THE LOAI
DELETE FROM THELOAI
INSERT INTO THELOAI VALUES('MA01',N'VĂN HỌC','null',N'ĐA DẠNG')
INSERT INTO THELOAI VALUES('MA02',N'LỊCH SỬ','null',N'ĐA DẠNG')
INSERT INTO THELOAI VALUES('MA03',N'HÓA HỌC','null',N'ĐA DẠNG')
INSERT INTO THELOAI VALUES('MA04',N'SINH HỌC','null',N'ĐA DẠNG')
INSERT INTO THELOAI VALUES('MA05',N'ĐỊA LÝ','null',N'ĐA DẠNG')
----- TAO BANG TAC GIA

-----TAO BANG SACH
DELETE FROM SACH
INSERT INTO SACH VALUES('MS001','MA01',N'TRUYỆN KIỀU',650,10000,350000,'5/31/1993',N'SỐ 1',N'SÁCH HAY',50)
INSERT INTO SACH VALUES('MS002','MA02',N'LỊCH SỬ THẾ KỈ 19',555,10040,320000,'5/5/1993',N'SỐ 2',N'SÁCH HAY',70)
INSERT INTO SACH VALUES('MS003','MA03',N'HÓA HỌC 12',650,10000,350000,'5/3/1993',N'SỐ 1',N'SÁCH HAY',80)
INSERT INTO SACH VALUES('MS004','MA04',N'SINH HỌC 12',750,10000,350000,'9/30/1993',N'SỐ 1',N'SÁCH HAY',150)
INSERT INTO SACH VALUES('MS005','MA05',N'ĐỊA LÝ 12',610,10000,350000,'5/1/1993',N'SỐ 1',N'SÁCH HAY',40)
------TAO BANG SACH_TACGIA

-----TAO BANG NGANH
DELETE FROM NGANH
INSERT INTO NGANH VALUES('MN012',N'CÔNG NGHỆ THÔNG TIN','NULL')
INSERT INTO NGANH VALUES('MN013',N'KỸ THUẬT CƠ KHÍ','NULL')
INSERT INTO NGANH VALUES('MN014',N'XÂY DƯNG CẦU ĐƯỜNG','NULL')
INSERT INTO NGANH VALUES('MN015',N'CƠ ĐIỆN TỬ','NULL')
INSERT INTO NGANH VALUES('MN016',N'KINH TẾ VẬN TẢI','NULL')
------TAO BANG LOP
DELETE FROM LOP
INSERT INTO LOP VALUES('L012','15101UD','MN012')
INSERT INTO LOP VALUES('L013','15102CK','MN013')
INSERT INTO LOP VALUES('L014','15103CD','MN014')
INSERT INTO LOP VALUES('L015','15104DT','MN015')
INSERT INTO LOP VALUES('L016','15105KT','MN016')
------TAO BANG SINH VIEN
DELETE FROM SINHVIEN
INSERT INTO SINHVIEN VALUES('0917',N'NGUYỄN HẢI YẾN',1,N'HÀ NỘI','HAIYENNT@GMAIL.COM','01234789999','null','l012')
INSERT INTO SINHVIEN VALUES('0916',N'NGUYỄN TRỌNG QUANG',0,N'THANH HÓA','QUANGNT@GMAIL.COM','0123478979','null','L014')
INSERT INTO SINHVIEN VALUES('PH0914',N'NGUYỄN THI YẾN',1,N'HÀ NỘI','YENNT@GMAIL.COM','0123478876','null','L015')
INSERT INTO SINHVIEN VALUES('PH0913',N'NGUYỄN VĂN HẢI',0,N'THANH HÓA','HIYNNT@GMAIL.COM','01234793335','null','L016')

INSERT INTO SINHVIEN VALUES('0123',N'NGUYỄN Văn Minh',0,N'THANH HÓA','minh@gmail.com','0238493284','null','L013')
INSERT INTO SINHVIEN VALUES('1234',N'NGUYỄN HẢI Cảnh',1,N'HÀ NỘI','Haicanh@GMAIL.COM','0923849444','null','l012')
INSERT INTO SINHVIEN VALUES('2345',N'NGUYỄN TRỌNG Nhân',0,N'THANH HÓA','Nhansss@GMAIL.COM','0983409813','null','L013')
INSERT INTO SINHVIEN VALUES('3456',N'NGUYỄN THỊ ANH',1,N'THANH HÓA','NGUYENANH2007@GMAIL.COM','0198329823','null','L014')
INSERT INTO SINHVIEN VALUES('4567',N'NGUYỄN THI YẾN Nhi',1,N'HÀ NỘI','YENNT12@GMAIL.COM','092841237','null','L015')
INSERT INTO SINHVIEN VALUES('5678',N'NGUYỄN MINH HẢI',0,N'THANH HÓA','HIddYNNT@GMAIL.COM','01234793335','null','L016')
INSERT INTO SINHVIEN VALUES('6789',N'NGUYỄN Vân Anh',1,N'THANH HÓA','vannha@GMAIL.COM','0983723483','null','L014')
INSERT INTO SINHVIEN VALUES('7891',N'NGUYỄN THI YẾN',1,N'HÀ NỘI','YENNT@GMAIL.COM','08734224','null','L015')

INSERT INTO SINHVIEN VALUES('1342',N'NGUYỄN VĂN HẢI ',0,N'THANH HÓA','HIY1NNT@GMAIL.COM','095467444','null','L016')
INSERT INTO SINHVIEN VALUES('2341',N'NGUYỄN HẢI YẾN',1,N'HÀ NỘI','HAIYEN1NT@GMAIL.COM','09876546786','null','l012')
INSERT INTO SINHVIEN VALUES('1234',N'NGUYỄN TRỌNG QUANG',0,N'THANH HÓA','QUANG1NT@GMAIL.COM','4567898765','null','L013')
INSERT INTO SINHVIEN VALUES('0789',N'NGUYỄN THỊ ANH',1,N'THANH HÓA','NGUYE1NANH@GMAIL.COM','0923456764','null','L014')
INSERT INTO SINHVIEN VALUES('7858',N'NGUYỄN THI YẾN',1,N'HÀ NỘI','YENNT11@GMAIL.COM','0987643567','null','L015')
INSERT INTO SINHVIEN VALUES('4452',N'NGUYỄN VĂN HẢI',0,N'THANH HÓA','HI11YNNT@GMAIL.COM','09868765e','null','L016')
INSERT INTO SINHVIEN VALUES('1122',N'NGUYỄN HẢI YẾN',1,N'HÀ NỘI','111@GMAIL.COM','098745623434','null','l012')
INSERT INTO SINHVIEN VALUES('3344',N'NGUYỄN TRỌNG QUANG',0,N'THANH HÓA','QUA11NGNT@GMAIL.COM','87935443','null','L013')
INSERT INTO SINHVIEN VALUES('5544',N'NGUYỄN THỊ ANH',1,N'THANH HÓA','NGUYEN22ANH@GMAIL.COM','057895278','null','L014')
INSERT INTO SINHVIEN VALUES('4477',N'NGUYỄN THI YẾN',1,N'HÀ NỘI','YEN22NT@GMAIL.COM','04554646545','null','L015')
INSERT INTO SINHVIEN VALUES('7788',N'NGUYỄN VĂN HẢI',0,N'THANH HÓA','222@GMAIL.COM','0868656445','null','L016')
------ nhân viên
INSERT INTO NHANVIEN VALUES('MNV01','123',N'Nguyễn Trọng Quang',1,0382785573,N'Quảng Vọng_Quảng Xương_Thanh Hóa',1)
INSERT INTO NHANVIEN VALUES('MNV02','123',N'Nguyễn Thị Anh',0,0385199207,N'Quảng Long_Quảng Xương_Thanh Hóa',1)
INSERT INTO NHANVIEN VALUES('MNV03','123',N'Cao Thị Việt',0,0912838292,N'Quảng Vọng_Quảng Xương_Thanh Hóa',1)
INSERT INTO NHANVIEN VALUES('MNV04','123',N'Nguyễn Thị Yến',0,032384833,N'Quảng Yên_Quảng Xương_Thanh Hóa',0)
INSERT INTO NHANVIEN VALUES('MNV05','123',N'Nguyễn Thị Ngân',0,092384098,N'Quảng Vọng_Quảng Xương_Thanh Hóa',0)
INSERT INTO NHANVIEN VALUES('MNV06','123',N'Nguyễn Văn Bình',1,098334449,N'Đà Nẵng',0)

-----TAO BANG PHIEU MUON
DELETE FROM PHIEUMUON
INSERT INTO PHIEUMUON VALUES('MSP78','5-31-2019','0917')
INSERT INTO PHIEUMUON VALUES('MSP74','5-31-2019','0916')
INSERT INTO PHIEUMUON VALUES('MSP73','5-31-2019','0918')
INSERT INTO PHIEUMUON VALUES('MSP72','5-31-2019','PH0914')
INSERT INTO PHIEUMUON VALUES('MSP71','5-31-2019','PH0913')
-----TAO BANG CT PHIEU MUON
DELETE FROM CTPHIEUMUON
INSERT INTO CTPHIEUMUON VALUES('MNV01','0917','MSP78','MS001','9') 
INSERT INTO CTPHIEUMUON VALUES('MNV02','0916','MSP74','MS002','6')
INSERT INTO CTPHIEUMUON VALUES('MNV03','PH0914','MSP73','MS003','3')
INSERT INTO CTPHIEUMUON VALUES('MNV05','PH0913','MSP72','MS004','12')
INSERT INTO CTPHIEUMUON VALUES('MNV06','0918','MSP71','MS005','11')
SELECT * FROM CTPHIEUMUON  
SELECT * FROM PHIEUMUON  
SELECT * FROM SINHVIEN  
SELECT * FROM LOP 
SELECT * FROM NGANH

SELECT * FROM SACH 

SELECT * FROM THELOAI
SELECT * FROM NHANVIEN
-------
































///***************
6.1 Liệt kê tất cả thông tin của các đầu sách gồm tên sách, mã sách, giá tiền , tác giả thuộc loại sách có mã “IT”.

SELECT TENSACH, SACH_TACGIA.MASACH, GIABIA, MTG, MTL
FROM SACH JOIN SACH_TACGIA ON SACH.MASACH = SACH_TACGIA.MASACH
WHERE MTL LIKE 'MA01'

--- -6.2  Liệt kê các phiếu mượn gồm các thông tin mã phiếu mượn, mã sách , ngày mượn, mã sinh viên có ngày mượn trong tháng 01/2017.
 SELECT CTPHIEUMUON.MSP, MSV, MASACH, NGAYMUON
 FROM PHIEUMUON JOIN CTPHIEUMUON ON PHIEUMUON.MSP = CTPHIEUMUON.MSP
 WHERE MONTH(NGAYMUON) = 05 AND YEAR(NGAYMUON)= 2019

--- 6.3 Liệt kê các phiếu mượn chưa trả sách cho thư viên theo thứ tự tăng dần của ngày mượn sách.
 --------THEEM COT TRANG THAI
 ALTER TABLE PHIEUMUON
 ADD TRANGTHAI NVARCHAR(50)
 ------
 UPDATE PHIEUMUON
 SET TRANGTHAI = N'CHƯA TRẢ SACH'
 WHERE MSP LIKE '%8'
 -----
 SELECT MSP, MSV, NGAYMUON, GETDATE() AS NGAYTRA, TRANGTHAI
 FROM PHIEUMUON
 WHERE TRANGTHAI LIKE N'CHƯA%'
 ----6.4 Liệt kê tổng số đầu sách của mỗi loại sách ( gồm mã loại sách, tên loại sách, tổng số lượng sách mỗi loại).
 SELECT SACH.MTL, TENTL, COUNT(SACH.MTL) AS TONGLOAI
 FROM THELOAI JOIN SACH ON THELOAI.MTL = SACH.MTL
 GROUP BY SACH.MTL, TENTL


  SELECT SACH.MTL,TENTL, COUNT(SACH.MTL) AS TONGLOAI
 FROM THELOAI JOIN SACH ON THELOAI.MTL = SACH.MTL
 GROUP BY SACH.MTL, TENTL
 
 SELECT SACH.MTL,TENTL, COUNT(SACH.MTL) AS TONGLOAI
 FROM THELOAI JOIN SACH ON THELOAI.MTL = SACH.MTL
 GROUP BY SACH.MTL, TENTL
 SELECT * FROM SACH 
 SELECT * FROM THELOAI
 6.5 Đếm xem có bao nhiêu  lượt sinh viên đã mượn sách.
 SELECT COUNT(MSV) AS LUOTMUOT
 FROM SINHVIEN
 WHERE MSV IN (SELECT MSV FROM SINHVIEN)


 6.6 Hiển thị tất cả các quyển sách có tiêu đề chứa từ khoá “SQL”.
 SELECT MASACH, MTL, TENSACH 
 FROM SACH 
 WHERE TENSACH LIKE N'TRUYỆN KIỀU'

---- 6.7 Hiển thị thông tin mượn sách gồm các thông tin: mã sinh viên, tên sinh viên, mã phiếu mượn, tiêu đề sách, ngày mượn, ngày trả. Sắp xếp thứ tự theo ngày mượn sách.
SELECT SINHVIEN.MSV, HODEM, TEN, CTPHIEUMUON.MSP, TENSACH, NGAYMUON, GETDATE() AS NGAYTRA
FROM PHIEUMUON JOIN SINHVIEN ON SINHVIEN.MSV = PHIEUMUON.MSV
                JOIN CTPHIEUMUON ON PHIEUMUON.MSP = CTPHIEUMUON.MSP
				JOIN SACH ON SACH.MASACH = CTPHIEUMUON.MASACH
ORDER BY NGAYMUON ASC
-----6.8 Liệt kê các đầu sách có lượt mượn lớn hơn 20 lần.
SELECT MASACH, TENSACH, COUNT(MASACH) AS LUOTMUON
FROM SACH 
GROUP BY MASACH, TENSACH
HAVING COUNT(MASACH) >=1

----- 6.9 Viết câu lệnh cập nhật lại giá tiền của các quyển sách có ngày nhập kho trước năm 2014 giảm 30%. 
---- TAO CT MÓI 
ALTER TABLE SACH
ADD GIAMOI MONEY 
-------
UPDATE SACH
SET GIAMOI = GIABIA * 0.7
WHERE YEAR(NXB) = 1993
SELECT * FROM SACH


----- 6.11 Lập danh sách các phiếu mượn quá hạn chưa trả gồm các thông tin: mã phiếu mượn, tên sinh viên, email, danh sách các sách đã mượn, ngày mượn. 
SELECT CTPHIEUMUON.MSP, HODEM, TEN, NGAYMUON,  MASACH, EMAIL,  GETDATE() AS NGAYTRA, DATEDIFF(DAY, NGAYMUON, GETDATE()) AS SONGAY
FROM SINHVIEN JOIN PHIEUMUON ON SINHVIEN.MSV = PHIEUMUON.MSV
              JOIN CTPHIEUMUON ON PHIEUMUON.MSP = CTPHIEUMUON.MSP
WHERE DATEDIFF(DAY, NGAYMUON, GETDATE()) > 2
 -----6.12 Viết câu lệnh cập nhật lại số lượng bản sao tăng lên 5 đơn vị đối với các đầu sách có lượt mượn lớn hơn 10 
 -----TAO COT SL BAN SAO MOI 
 ALTER TABLE SACH
 ADD SLMOI INT
 ---- UPDATE
 UPDATE SACH
     SET SLMOI = SOBANSAO + 5
     WHERE MASACH IN ( SELECT MASACH FROM CTPHIEUMUON
     GROUP BY MASACH
     HAVING COUNT(MASACH) > 5)
SELECT * FROM SACH
 -----6.13 Viết câu lệnh xoá các phiếu mượn có ngày mượn và ngày trả trước „1/1/2010‟ 
 ---TAO BANG MOI 
  SELECT * INTO PM FROM PHIEUMUON
  SELECT * INTO CTPM FROM CTPHIEUMUON
  -----------KIEM THU BANG MOI
  SELECT * FROM PM
  SELECT * FROM CTPM

 DELETE  FROM CTPM 
 WHERE MSP IN (SELECT MSP FROM PHIEUMUON
 WHERE NGAYMUON < '1-5-2019')
DELETE FROM PM
WHERE NGAYMUON < '02-20-2019'





select * from SINHVIEN order by MSV